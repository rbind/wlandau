---
layout: post
title: "ggplot2 and memory efficiency"
comments: true
root: "../../../../"
--- 

<h2><code>ggplot2</code> and memory efficiency</h2>

<p>The R language package, <code>ggplot2</code>, is an easy, quick,
 intuitive way to make informative, professional-looking plots. However,
data must be stored as a two-dimensional, R-style data frame. 
<code>ggplot2</code> does not currently accept multidimensional arrays, 
a limitation that sometimes detracts from memory efficiency.</p>

<p>Consider a hypothetical RNA sequencing experiment with 288 mice. I assign half the mice to
diet 1 and half to diet 2. Within each diet, I assign them in groups of 6
to one of 6 different drug treatments. After 30 days, I sequence 
the genomes of all the 288 mice. I generate a fake dataset from such an experiment
using R:</p>

<pre><code>> lambda = array(runif(288, 30, 90), dim = c(2, 6, 6))
>
> dimnames(lambda)[[1]] = paste("Diet",  as.roman(1:2))
> dimnames(lambda)[[2]] = paste("Drug",  LETTERS[1:6])
> dimnames(lambda)[[3]] = paste("Rep",  1:6)

> a.array = apply(lambda, 1:3, function(x){rpois(50000,x)})

> dimnames(a.array)[[1]] = paste("Gene",  1:50000)
</code></pre>

<p>Here's what the data look like as a multidimensional array:</p>


<pre><code>> str(a.array)
 num [1:50000, 1:2, 1:6, 1:6] 50 28 26 19 29 41 24 32 32 23 ...
 - attr(*, "dimnames")=List of 4
  ..$ : chr [1:50000] "Gene 1" "Gene 2" "Gene 3" "Gene 4" ...
  ..$ : chr [1:2] "Diet I" "Diet II"
  ..$ : chr [1:6] "Drug A" "Drug B" "Drug C" "Drug D" ...
  ..$ : chr [1:6] "Rep 1" "Rep 2" "Rep 3" "Rep 4" ...
>
> a.array[1:5,1:2,1:2,1]
, , Drug A

       Diet I Diet II
Gene 1     50      64
Gene 2     28      58
Gene 3     26      65
Gene 4     19      80
Gene 5     29      65

, , Drug B

       Diet I Diet II
Gene 1     91      67
Gene 2     92      56
Gene 3     80      60
Gene 4     77      64
Gene 5     85      54

</code></pre>

<p>Suppose I want to use <code>ggplot2</code> to make overlaying histograms
of the gene expression levels of the diets, faceting by drug and replicate:</p>

<img align="middle" src="{{page.root}}img/2013-05-01-post.png" height="650px" width="650px"/>

<p>As with all things <code>ggplot2</code>, the code to make 
this plot is simple and elegant.</p>

<pre><code>> library(ggplot2)
>
> pl = ggplot(a.data.frame, aes(x = Expression_Level)) +
>     geom_histogram(aes(fill = Diet), alpha = 0.5, position = "identity") +
>     facet_grid(Drug ~ Rep) + xlab("Expression Level") + ylab("Frequency")
>
> ggsave("2013-05-01-post.png", width = 8, height = 8)
</pre></code>

<p>However, before making the plot, we need to convert the multidimensional array 
into a two-dimensional, "short form" data frame.</p>

<pre><code>> library(reshape2)
> 
> a.data.frame = melt(a.array)
> colnames(a.data.frame) = c("Gene", "Diet", "Drug", "Rep", 
>                            "Expression_Level")
</pre></code>

<p><code>a.data.frame</code> takes up almost three times the memory of <code>a.array</code>.</p>

<pre><code>> print(object.size(a.array), units = "Mb")
30.5 Mb
> print(object.size(a.data.frame), units = "Mb")
85.5 Mb
</code></pre>

<p>Why the increase in size? Look at the data frame.</p>

<pre><code>> dim(a.data.frame)
[1] 3600000       5
>
> head(a.data.frame)
    Gene   Diet   Drug   Rep Expression_Level
1 Gene 1 Diet I Drug A Rep 1               50
2 Gene 2 Diet I Drug A Rep 1               28
3 Gene 3 Diet I Drug A Rep 1               26
4 Gene 4 Diet I Drug A Rep 1               19
5 Gene 5 Diet I Drug A Rep 1               29
6 Gene 6 Diet I Drug A Rep 1               41
</pre></code>

<p>Information about diet, drug, and replicate, previously stored compactly in
array dimension names, now takes up 3 whole new columns in the data frame. 
That's 10.8 million redundant character strings, an additional 
65 Mb.</p>

<p><code>ggplot2</code> is an amazing tool, so I hate to see it rely on memory inefficient
data structures. Reliance on tidy, short form data may hard to extricate from the implementation 
of the package, but for massive datasets that dwarf my toy example, 
accommodating multidimensional arrays could save several gigabytes of memory.</p>